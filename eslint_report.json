[{"filePath":"/Users/tevin/Suntel/bcoffee-admin/src/features/menu/components/product-sheet.tsx","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":92,"column":31,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":92,"endColumn":34,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[2537,2540],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[2537,2540],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":154,"column":39,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":154,"endColumn":42,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[3927,3930],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[3927,3930],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":187,"column":37,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":187,"endColumn":40,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[5005,5008],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[5005,5008],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"The 'choices' logical expression could make the dependencies of useMemo Hook (at line 486) change on every render. To fix this, wrap the initialization of 'choices' in its own useMemo() Hook.","line":405,"column":9,"nodeType":"VariableDeclarator","endLine":406,"endColumn":69},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":419,"column":46,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":419,"endColumn":49,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[12013,12016],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[12013,12016],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":420,"column":58,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":420,"endColumn":61,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[12091,12094],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[12091,12094],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":440,"column":33,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":440,"endColumn":36,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[12770,12773],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[12770,12773],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":449,"column":13,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":449,"endColumn":16,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[13117,13120],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[13117,13120],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":452,"column":36,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":452,"endColumn":39,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[13193,13196],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[13193,13196],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":489,"column":54,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":489,"endColumn":57,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[14306,14309],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[14306,14309],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":490,"column":54,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":490,"endColumn":57,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[14376,14379],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[14376,14379],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":491,"column":56,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":491,"endColumn":59,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[14448,14451],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[14448,14451],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":492,"column":56,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":492,"endColumn":59,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[14522,14525],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[14522,14525],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":980,"column":44,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":980,"endColumn":47,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[35408,35411],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[35408,35411],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":986,"column":45,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":986,"endColumn":48,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[35708,35711],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[35708,35711],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":1002,"column":46,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":1002,"endColumn":49,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[36387,36390],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[36387,36390],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":1005,"column":53,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":1005,"endColumn":56,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[36583,36586],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[36583,36586],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":1032,"column":41,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":1032,"endColumn":44,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[37963,37966],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[37963,37966],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":1078,"column":41,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":1078,"endColumn":44,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[40392,40395],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[40392,40395],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":1086,"column":94,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":1086,"endColumn":97,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[40828,40831],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[40828,40831],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":1100,"column":62,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":1100,"endColumn":65,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[41632,41635],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[41632,41635],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":1114,"column":65,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":1114,"endColumn":68,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[42324,42327],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[42324,42327],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":21,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { useEffect, useState, useMemo } from 'react'\nimport { type z } from 'zod'\nimport {\n  useForm,\n  useFieldArray,\n  useWatch,\n  type Control,\n  type Resolver,\n} from 'react-hook-form'\nimport { zodResolver } from '@hookform/resolvers/zod'\nimport {\n  type OptionGroup,\n  type OptionChoice,\n  type CreateProductRequest,\n} from '@/types/api'\nimport _ from 'lodash'\nimport { ChevronRight, Plus } from 'lucide-react'\nimport { toast } from 'sonner'\nimport { calculateRecipeCost, calculateMargin } from '@/utils/cost-engine'\nimport { formatCurrency } from '@/utils/format'\nimport { getTranslation } from '@/utils/i18n'\nimport {\n  useCategories,\n  useCreateProduct,\n  useUpdateProduct,\n  useOptionGroups,\n} from '@/hooks/queries/use-catalog'\nimport { Badge } from '@/components/ui/badge'\nimport { BrandLoader } from '@/components/ui/brand-loader'\nimport { Button } from '@/components/ui/button'\nimport { Card, CardContent, CardHeader, CardTitle } from '@/components/ui/card'\nimport { Checkbox } from '@/components/ui/checkbox'\nimport {\n  Collapsible,\n  CollapsibleContent,\n  CollapsibleTrigger,\n} from '@/components/ui/collapsible'\nimport {\n  Form,\n  FormControl,\n  FormField,\n  FormItem,\n  FormLabel,\n  FormMessage,\n} from '@/components/ui/form'\nimport { Input } from '@/components/ui/input'\nimport {\n  Select,\n  SelectContent,\n  SelectItem,\n  SelectTrigger,\n  SelectValue,\n} from '@/components/ui/select'\nimport {\n  Sheet,\n  SheetContent,\n  SheetDescription,\n  SheetHeader,\n  SheetTitle,\n} from '@/components/ui/sheet'\nimport { Tabs, TabsContent, TabsList, TabsTrigger } from '@/components/ui/tabs'\nimport { MultiLangImageUpload } from '@/components/custom/multi-lang-image-upload'\nimport { MultiLangInput } from '@/components/custom/multi-lang-input'\nimport { MultiLangTextarea } from '@/components/custom/multi-lang-textarea'\nimport { MOCK_INGREDIENTS } from '../data/mock-ingredients'\nimport {\n  type Category,\n  productSchema,\n  ProductStatus,\n  type Product,\n  OptionType,\n} from '../data/schema'\n\ntype ProductFormValues = z.infer<typeof productSchema>\n\nconst UNIT_SYMBOLS: Record<string, string> = {\n  grams: 'g',\n  milliliters: 'ml',\n  ml: 'ml',\n  pump: 'p',\n  piece: 'pcs',\n  ounces: 'oz',\n  oz: 'oz',\n}\n\nfunction RecipeUnitSuffix({ ingredientId }: { ingredientId: string }) {\n  const ingredient = MOCK_INGREDIENTS.find((i) => i.id === ingredientId)\n  if (!ingredient)\n    return <span className='min-w-[24px] text-xs text-muted-foreground'>-</span>\n\n  // Handle both string and object (as requested)\n  const unit = (ingredient as any).unit\n  let symbol = '-'\n\n  if (typeof unit === 'object' && unit !== null) {\n    symbol = getTranslation(unit.symbol)\n  } else if (typeof unit === 'string') {\n    symbol = UNIT_SYMBOLS[unit.toLowerCase()] || unit\n  }\n\n  return (\n    <span className='min-w-[24px] shrink-0 text-xs text-muted-foreground'>\n      {symbol}\n    </span>\n  )\n}\n\nfunction RecipeCostBadge({\n  ingredientId,\n  quantity,\n}: {\n  ingredientId: string\n  quantity: number\n}) {\n  const ingredient = MOCK_INGREDIENTS.find((i) => i.id === ingredientId)\n  const cost = (ingredient?.costPerUnit || 0) * (Number(quantity) || 0)\n\n  if (cost <= 0) return null\n\n  return (\n    <Badge\n      variant='outline'\n      className='shrink-0 bg-muted/30 px-1.5 py-0 font-mono text-[10px] whitespace-nowrap'\n    >\n      ${cost.toFixed(2)}\n    </Badge>\n  )\n}\n\nfunction RecipeRow({\n  control,\n  index,\n  isFixedIngredient = false,\n  onRemove,\n}: {\n  control: Control<ProductFormValues>\n  index: number\n  isFixedIngredient?: boolean\n  onRemove?: () => void\n}) {\n  const ingredientId = useWatch({\n    control,\n    name: `recipes.${index}.ingredientId` as const,\n  })\n  const quantity = useWatch({\n    control,\n    name: `recipes.${index}.quantity` as const,\n  })\n\n  return (\n    <div className='flex items-end gap-3 pl-2'>\n      <div className='flex min-w-0 flex-1 items-end gap-2'>\n        <FormField\n          control={control as Control<any>}\n          name={`recipes.${index}.ingredientId`}\n          render={({ field }) => (\n            <FormItem className='flex-1'>\n              <Select\n                onValueChange={field.onChange}\n                defaultValue={field.value}\n                disabled={isFixedIngredient}\n              >\n                <FormControl>\n                  <SelectTrigger>\n                    <SelectValue placeholder='Select ingredient' />\n                  </SelectTrigger>\n                </FormControl>\n                <SelectContent>\n                  {MOCK_INGREDIENTS.map((ingredient) => (\n                    <SelectItem key={ingredient.id} value={ingredient.id}>\n                      {ingredient.name}\n                    </SelectItem>\n                  ))}\n                </SelectContent>\n              </Select>\n              <FormMessage />\n            </FormItem>\n          )}\n        />\n        <RecipeCostBadge\n          ingredientId={ingredientId}\n          quantity={Number(quantity)}\n        />\n      </div>\n\n      <FormField\n        control={control as Control<any>}\n        name={`recipes.${index}.quantity`}\n        render={({ field }) => (\n          <FormItem className='w-32 shrink-0'>\n            <FormControl>\n              <div className='flex items-center gap-1.5'>\n                <Input\n                  type='number'\n                  {...field}\n                  className='w-20 [appearance:textfield] text-right [&::-webkit-inner-spin-button]:appearance-none [&::-webkit-outer-spin-button]:appearance-none'\n                  value={field.value as number | string}\n                  onChange={(e) => field.onChange(Number(e.target.value))}\n                />\n                <RecipeUnitSuffix ingredientId={ingredientId} />\n              </div>\n            </FormControl>\n            <FormMessage />\n          </FormItem>\n        )}\n      />\n\n      <div className='flex h-9 w-9 shrink-0 items-center justify-center'>\n        {onRemove && (\n          <Button\n            type='button'\n            variant='ghost'\n            size='icon'\n            onClick={onRemove}\n            className='h-9 w-9 text-muted-foreground hover:text-destructive'\n          >\n            &times;\n          </Button>\n        )}\n      </div>\n    </div>\n  )\n}\n\nfunction VirtualInheritedRow({\n  ingredientId,\n  baseQuantity,\n  onOverride,\n}: {\n  ingredientId: string\n  baseQuantity: number\n  onOverride: (quantity: number) => void\n}) {\n  const [val, setVal] = useState(baseQuantity)\n\n  return (\n    <div className='flex items-end gap-3 pl-2 opacity-80 transition-opacity hover:opacity-100'>\n      <div className='flex min-w-0 flex-1 items-end gap-2'>\n        <div className='flex-1 space-y-2'>\n          <Select disabled value={ingredientId}>\n            <SelectTrigger className='bg-muted/50'>\n              <SelectValue />\n            </SelectTrigger>\n            <SelectContent>\n              {MOCK_INGREDIENTS.map((ingredient) => (\n                <SelectItem key={ingredient.id} value={ingredient.id}>\n                  {ingredient.name}\n                </SelectItem>\n              ))}\n            </SelectContent>\n          </Select>\n        </div>\n        <RecipeCostBadge ingredientId={ingredientId} quantity={val} />\n      </div>\n\n      <div className='w-32 shrink-0 space-y-2'>\n        <div className='flex items-center gap-1.5'>\n          <Input\n            type='number'\n            value={val}\n            onChange={(e) => {\n              const n = Number(e.target.value)\n              setVal(n)\n              onOverride(n)\n            }}\n            className='w-20 [appearance:textfield] border-dashed text-right [&::-webkit-inner-spin-button]:appearance-none [&::-webkit-outer-spin-button]:appearance-none'\n          />\n          <RecipeUnitSuffix ingredientId={ingredientId} />\n        </div>\n      </div>\n      <div className='flex h-9 w-9 shrink-0 items-center justify-center' />\n    </div>\n  )\n}\n\nfunction OptionGroupDetails({ group }: { group: OptionGroup }) {\n  if (!group?.choices?.length) {\n    return (\n      <div className='py-2 text-sm text-muted-foreground'>\n        No choices found.\n      </div>\n    )\n  }\n\n  return (\n    <div className='grid gap-2 py-2'>\n      <div className='mb-1 grid grid-cols-2 text-xs font-medium text-muted-foreground'>\n        <span>Choice Name</span>\n        <span className='text-right'>Price</span>\n      </div>\n      {group.choices.map((option: OptionChoice) => (\n        <div key={option.id || option.sku} className='grid grid-cols-2 text-sm'>\n          <span>{option.name['en'] || 'Untitled'}</span>\n          <span className='text-right font-mono'>\n            {option.price > 0 ? `${formatCurrency(option.price)}` : '-'}\n          </span>\n        </div>\n      ))}\n    </div>\n  )\n}\n\ninterface ProductSheetProps {\n  open: boolean\n  onOpenChange: (open: boolean) => void\n  product?: Product | null // Adding product prop for edit mode\n}\n\nexport function ProductSheet({\n  open,\n  onOpenChange,\n  product,\n}: ProductSheetProps) {\n  const { data: categories } = useCategories()\n  const { data: optionGroups } = useOptionGroups()\n  const { mutate: createProduct, isPending: isCreating } = useCreateProduct()\n  const { mutate: updateProduct, isPending: isUpdating } = useUpdateProduct()\n\n  // Removed unused isPending variable if it's not used in UI or use it if needed.\n  const isPending = isCreating || isUpdating\n\n  const form = useForm<ProductFormValues>({\n    resolver: zodResolver(productSchema) as Resolver<ProductFormValues>,\n    defaultValues: product || {\n      name: { en: '' },\n      description: { en: '' },\n      sku: '',\n      price: {\n        name: { en: 'Size' },\n        type: OptionType.VARIANT,\n        sku: '',\n        minSelect: 1,\n        maxSelect: 1,\n        choices: [\n          {\n            sku: '',\n            name: { en: 'Standard' },\n            price: 0,\n          },\n        ],\n      },\n      priceGroupId: '',\n      categoryId: '',\n      status: ProductStatus.DRAFT,\n      imageUrl: {},\n      optionGroupIds: [],\n      recipes: [],\n    },\n  })\n\n  // Reset form when product changes or sheet opens\n  useEffect(() => {\n    if (open) {\n      form.reset(\n        product || {\n          name: { en: '' },\n          description: { en: '' },\n          sku: '',\n          price: {\n            name: { en: 'Size' },\n            type: OptionType.VARIANT,\n            sku: '',\n            minSelect: 1,\n            maxSelect: 1,\n            choices: [\n              {\n                sku: '',\n                name: { en: 'Standard' },\n                price: 0,\n              },\n            ],\n          },\n          priceGroupId: '',\n          categoryId: '',\n          status: ProductStatus.DRAFT,\n          imageUrl: {},\n          optionGroupIds: [],\n          recipes: [],\n        }\n      )\n    }\n  }, [open, product, form])\n\n  // Watch SKU to auto-generate price SKU\n  const productSku = useWatch({ control: form.control, name: 'sku' })\n  useEffect(() => {\n    const currentPriceSku = form.getValues('price.sku')\n    if (\n      productSku &&\n      (!currentPriceSku ||\n        currentPriceSku === `${productSku}-VAR` ||\n        currentPriceSku.endsWith('-VAR'))\n    ) {\n      form.setValue('price.sku', `${productSku}-VAR`)\n    }\n  }, [productSku, form])\n\n  // ... (recipes array and cost calculations remain same) ...\n\n  const { fields, append, remove } = useFieldArray({\n    control: form.control,\n    name: 'recipes',\n  })\n\n  const choices =\n    useWatch({ control: form.control, name: 'price.choices' }) || []\n\n  // Watch recipe fields and price for live cost calculation\n  const recipeItems = useWatch({ control: form.control, name: 'recipes' })\n  // For cost calc, if single price, use that. If variant, maybe use lowest?\n  // Let's just use the first choice's price for now as a rough estimate or 0.\n  const priceData = useWatch({ control: form.control, name: 'price' })\n\n  // Calculate costs per variant (or just base if no variants)\n  const variantMetrics = useMemo(() => {\n    if (!recipeItems) return []\n\n    // 1. Identify Base Ingredients\n    const baseItems = recipeItems.filter((i: any) => !i.optionId)\n    const baseIngredientsWithCost = baseItems.map((item: any) => {\n      const ingredient = MOCK_INGREDIENTS.find(\n        (i) => i.id === item.ingredientId\n      )\n      return {\n        ingredientId: item.ingredientId,\n        quantityUsed: Number(item.quantity || 0),\n        costPerUnit: ingredient?.costPerUnit || 0,\n      }\n    })\n\n    // If no variants, just return base metrics\n    if (!choices || choices.length <= 1) {\n      const cost = calculateRecipeCost(baseIngredientsWithCost)\n      const price = Number(priceData?.choices?.[0]?.price) || 0\n      const margin = calculateMargin(price, cost)\n      return [{ name: 'Base', cost, margin, price }]\n    }\n\n    // 2. Calculate for each variant\n    return choices.map((choice: any, index: number) => {\n      const choiceId = choice.id || choice.sku || `variant-${index}`\n      const price = Number(choice.price) || 0\n\n      // Start with base ingredients\n      const currentIngredients = [...baseIngredientsWithCost]\n\n      // Apply Overrides & Special Ingredients\n      const variantItems = recipeItems.filter(\n        (i: any) => i.optionId === choiceId\n      )\n\n      variantItems.forEach((vItem: any) => {\n        const ingredient = MOCK_INGREDIENTS.find(\n          (i) => i.id === vItem.ingredientId\n        )\n        const vItemCost = {\n          ingredientId: vItem.ingredientId,\n          quantityUsed: Number(vItem.quantity || 0),\n          costPerUnit: ingredient?.costPerUnit || 0,\n        }\n\n        // Check if it's an override (exists in base)\n        const baseIndex = currentIngredients.findIndex(\n          (b) => b.ingredientId === vItem.ingredientId\n        )\n\n        if (baseIndex !== -1) {\n          // Replace base with override\n          currentIngredients[baseIndex] = vItemCost\n        } else {\n          // Add as special ingredient\n          currentIngredients.push(vItemCost)\n        }\n      })\n\n      const cost = calculateRecipeCost(currentIngredients)\n      const margin = calculateMargin(price, cost)\n      return {\n        name: choice.name['en'] || `Variant ${index + 1}`,\n        cost,\n        margin,\n        price,\n        id: choiceId,\n      }\n    })\n  }, [recipeItems, choices, priceData])\n\n  // Derived Summary Metrics\n  const minCost = Math.min(...variantMetrics.map((v: any) => v.cost))\n  const maxCost = Math.max(...variantMetrics.map((v: any) => v.cost))\n  const minMargin = Math.min(...variantMetrics.map((v: any) => v.margin))\n  const maxMargin = Math.max(...variantMetrics.map((v: any) => v.margin))\n\n  function onSubmit(data: z.infer<typeof productSchema>) {\n    if (product?.id) {\n      updateProduct(\n        { id: product.id, data },\n        {\n          onSuccess: () => {\n            toast.success('Product updated successfully')\n            onOpenChange(false)\n            form.reset()\n          },\n          onError: () => {\n            toast.error('Failed to update product')\n          },\n        }\n      )\n    } else {\n      createProduct(data as unknown as CreateProductRequest, {\n        onSuccess: () => {\n          toast.success('Product created successfully')\n          onOpenChange(false)\n          form.reset()\n        },\n        onError: () => {\n          toast.error('Failed to create product')\n        },\n      })\n    }\n  }\n\n  return (\n    <Sheet open={open} onOpenChange={onOpenChange}>\n      <SheetContent className='flex w-full flex-col gap-6 overflow-y-auto p-4 sm:max-w-2xl'>\n        <SheetHeader>\n          <SheetTitle>Create Product</SheetTitle>\n          <SheetDescription>\n            Add a new product to your menu. Configure pricing, category, and\n            modifier options.\n          </SheetDescription>\n        </SheetHeader>\n\n        <Form {...form}>\n          <form\n            onSubmit={form.handleSubmit(onSubmit)}\n            className='flex flex-col gap-6'\n          >\n            <Tabs defaultValue='general' className='w-full'>\n              <TabsList className='grid w-full grid-cols-3'>\n                <TabsTrigger value='general'>General</TabsTrigger>\n                <TabsTrigger value='options'>Options</TabsTrigger>\n                <TabsTrigger value='recipes'>Recipes</TabsTrigger>\n              </TabsList>\n\n              <TabsContent value='general' className='space-y-4 py-4'>\n                <FormField\n                  control={form.control}\n                  name='imageUrl'\n                  render={({ field }) => (\n                    <FormItem>\n                      <FormLabel>Product Image</FormLabel>\n                      <FormControl>\n                        <MultiLangImageUpload\n                          value={field.value || {}}\n                          onChange={field.onChange}\n                          disabled={isPending}\n                        />\n                      </FormControl>\n                      <FormMessage />\n                    </FormItem>\n                  )}\n                />\n\n                <FormField\n                  control={form.control}\n                  name='name'\n                  render={({ field }) => (\n                    <FormItem>\n                      {/* Label is handled inside MultiLangInput */}\n                      <FormControl>\n                        <MultiLangInput\n                          label='Product Name'\n                          placeholder='e.g. Latte'\n                          value={field.value as Record<string, string>}\n                          onChange={field.onChange}\n                        />\n                      </FormControl>\n                      <FormMessage />\n                    </FormItem>\n                  )}\n                />\n\n                <FormField\n                  control={form.control}\n                  name='sku'\n                  render={({ field }) => (\n                    <FormItem>\n                      <FormLabel>SKU</FormLabel>\n                      <FormControl>\n                        <Input\n                          placeholder='SKU'\n                          {...field}\n                          disabled={!_.isEmpty(product)}\n                        />\n                      </FormControl>\n                      <FormMessage />\n                    </FormItem>\n                  )}\n                />\n\n                {/* Pricing Strategy Section */}\n                <FormLabel>Pricing Strategy</FormLabel>\n                <div className='rounded-lg border p-2'>\n                  <FormField\n                    control={form.control}\n                    name='price.name'\n                    render={({ field }) => (\n                      <FormItem>\n                        <FormControl>\n                          <MultiLangInput\n                            label='Label (e.g. Size)'\n                            placeholder='Size'\n                            value={field.value as Record<string, string>}\n                            onChange={field.onChange}\n                          />\n                        </FormControl>\n                        <FormMessage />\n                      </FormItem>\n                    )}\n                  />\n\n                  <div className='space-y-2'>\n                    <div className='mb-2 grid grid-cols-12 gap-2 px-2 pt-2'>\n                      <div className='col-span-5 text-sm font-medium'>\n                        Variant Name\n                      </div>\n                      <div className='col-span-3 text-sm font-medium'>\n                        Price\n                      </div>\n                      <div className='col-span-3 text-sm font-medium'>SKU</div>\n                      <div className='col-span-1'></div>\n                    </div>\n\n                    {/* Variants List */}\n                    {choices.map((_, index) => (\n                      <div\n                        key={index}\n                        className='grid grid-cols-12 items-end gap-2 p-2'\n                      >\n                        <div className='col-span-5'>\n                          <FormField\n                            control={form.control}\n                            name={`price.choices.${index}.name`}\n                            render={({ field }) => (\n                              <FormItem>\n                                <MultiLangInput\n                                  placeholder='Standard'\n                                  value={field.value as Record<string, string>}\n                                  onChange={field.onChange}\n                                />\n                              </FormItem>\n                            )}\n                          />\n                        </div>\n                        <div className='col-span-3'>\n                          <FormField\n                            control={form.control}\n                            name={`price.choices.${index}.price`}\n                            render={({ field }) => (\n                              <FormItem>\n                                <Input\n                                  type='number'\n                                  step='0.01'\n                                  {...field}\n                                  value={\n                                    typeof field.value === 'number'\n                                      ? field.value\n                                      : 0\n                                  }\n                                  onChange={(e) =>\n                                    field.onChange(Number(e.target.value))\n                                  }\n                                />\n                              </FormItem>\n                            )}\n                          />\n                        </div>\n                        <div className='col-span-3'>\n                          <FormField\n                            control={form.control}\n                            name={`price.choices.${index}.sku`}\n                            render={({ field }) => (\n                              <FormItem>\n                                <Input {...field} placeholder='SKU' />\n                              </FormItem>\n                            )}\n                          />\n                        </div>\n                        <div className='col-span-1 pt-1'>\n                          <Button\n                            type='button'\n                            variant='ghost'\n                            size='icon'\n                            onClick={() => {\n                              const choices =\n                                form.getValues('price.choices') || []\n                              form.setValue(\n                                'price.choices',\n                                choices.filter((__, i) => i !== index)\n                              )\n                            }}\n                          >\n                            &times;\n                          </Button>\n                        </div>\n                      </div>\n                    ))}\n\n                    <Button\n                      type='button'\n                      size='sm'\n                      variant='outline'\n                      className='mt-2 self-end'\n                      onClick={() => {\n                        const choices = form.getValues('price.choices') || []\n                        const parentSku = form.getValues('sku')\n                        const newSku = parentSku\n                          ? `${parentSku}-${choices.length + 1}`\n                          : `VAR-${choices.length + 1}`\n\n                        form.setValue('price.choices', [\n                          ...choices,\n                          {\n                            sku: newSku,\n                            name: { en: '' },\n                            price: 0,\n                          },\n                        ])\n                      }}\n                    >\n                      Add Variant\n                    </Button>\n                  </div>\n                </div>\n\n                <div className='grid grid-cols-2 gap-4'>\n                  <FormField\n                    control={form.control}\n                    name='categoryId'\n                    render={({ field }) => (\n                      <FormItem>\n                        <FormLabel>Category</FormLabel>\n                        <Select\n                          onValueChange={field.onChange}\n                          defaultValue={field.value}\n                        >\n                          <FormControl>\n                            <SelectTrigger>\n                              <SelectValue placeholder='Select category' />\n                            </SelectTrigger>\n                          </FormControl>\n                          <SelectContent>\n                            {categories?.map((category: Category) => (\n                              <SelectItem\n                                key={category.id}\n                                value={category.id || `cat-${category.slug}`}\n                              >\n                                {category.name['en']}\n                              </SelectItem>\n                            ))}\n                          </SelectContent>\n                        </Select>\n                        <FormMessage />\n                      </FormItem>\n                    )}\n                  />\n                  <FormField\n                    control={form.control}\n                    name='status'\n                    render={({ field }) => (\n                      <FormItem>\n                        <FormLabel>Status</FormLabel>\n                        <Select\n                          onValueChange={field.onChange}\n                          defaultValue={field.value}\n                        >\n                          <FormControl>\n                            <SelectTrigger>\n                              <SelectValue placeholder='Select status' />\n                            </SelectTrigger>\n                          </FormControl>\n                          <SelectContent>\n                            {Object.values(ProductStatus).map((status) => (\n                              <SelectItem key={status} value={status}>\n                                {status}\n                              </SelectItem>\n                            ))}\n                          </SelectContent>\n                        </Select>\n                        <FormMessage />\n                      </FormItem>\n                    )}\n                  />\n                </div>\n\n                <FormField\n                  control={form.control}\n                  name='description'\n                  render={({ field }) => (\n                    <FormItem>\n                      <FormControl>\n                        <MultiLangTextarea\n                          label='Description (Optional)'\n                          placeholder='Product description...'\n                          value={(field.value || {}) as Record<string, string>}\n                          onChange={field.onChange}\n                        />\n                      </FormControl>\n                      <FormMessage />\n                    </FormItem>\n                  )}\n                />\n              </TabsContent>\n\n              <TabsContent value='options' className='space-y-4 py-4'>\n                <FormField\n                  control={form.control}\n                  name='optionGroupIds'\n                  render={({ field }) => (\n                    <FormItem>\n                      <div className='grid gap-4'>\n                        {optionGroups?.map((group: OptionGroup) => (\n                          <Collapsible key={group.id}>\n                            <FormItem className='space-y-0'>\n                              <div className='flex cursor-pointer items-start space-x-3 rounded-md border p-3 transition-colors hover:bg-muted/50'>\n                                <FormControl\n                                  className='mt-1'\n                                  onClick={(e) => e.stopPropagation()}\n                                >\n                                  <Checkbox\n                                    checked={field.value?.includes(group.id)}\n                                    onCheckedChange={(checked) => {\n                                      return checked\n                                        ? field.onChange([\n                                            ...(field.value || []),\n                                            group.id,\n                                          ])\n                                        : field.onChange(\n                                            field.value?.filter(\n                                              (value) => value !== group.id\n                                            )\n                                          )\n                                    }}\n                                  />\n                                </FormControl>\n                                <div className='flex-1 space-y-2 leading-none'>\n                                  <div className='flex items-center'>\n                                    <FormLabel className='cursor-pointer text-base font-medium'>\n                                      {group.name['en'] || 'Untitled'}\n                                    </FormLabel>\n                                  </div>\n                                  <CollapsibleTrigger asChild>\n                                    <Button\n                                      variant='ghost'\n                                      size='sm'\n                                      className='group flex items-center gap-2 p-0 text-sm text-muted-foreground hover:bg-transparent'\n                                      type='button'\n                                      onClick={(e) => e.stopPropagation()}\n                                    >\n                                      <ChevronRight className='h-4 w-4 transition-transform duration-200 group-data-[state=open]:rotate-90' />\n                                      <span className='sr-only'>\n                                        Toggle choices\n                                      </span>\n                                      <Badge variant='outline'>\n                                        {group.type}\n                                      </Badge>\n                                      <span>\n                                        {group._count?.choices || 0} choices\n                                      </span>\n                                    </Button>\n                                  </CollapsibleTrigger>\n                                  <CollapsibleContent>\n                                    <div\n                                      className='mt-2 pl-0'\n                                      onClick={(e) => e.stopPropagation()}\n                                    >\n                                      <OptionGroupDetails group={group} />\n                                    </div>\n                                  </CollapsibleContent>\n                                </div>\n                              </div>\n                            </FormItem>\n                          </Collapsible>\n                        ))}\n                      </div>\n                      <FormMessage />\n                    </FormItem>\n                  )}\n                />\n              </TabsContent>\n\n              <TabsContent value='recipes' className='space-y-4 py-4'>\n                {!categories || !optionGroups ? (\n                  <div className='flex h-60 items-center justify-center'>\n                    <BrandLoader />\n                  </div>\n                ) : (\n                  <>\n                    <Card>\n                      <CardHeader className='pb-2'>\n                        <CardTitle className='text-sm font-medium'>\n                          Cost Summary\n                        </CardTitle>\n                      </CardHeader>\n                      <CardContent>\n                        <div className='grid grid-cols-2 gap-4'>\n                          <div>\n                            <div className='flex items-baseline gap-1'>\n                              <span className='text-2xl font-bold'>\n                                {minCost === maxCost\n                                  ? `$${minCost.toFixed(2)}`\n                                  : `$${minCost.toFixed(2)} - $${maxCost.toFixed(2)}`}\n                              </span>\n                            </div>\n                            <p className='text-xs text-muted-foreground'>\n                              {minCost === maxCost\n                                ? 'Total Ingredient Cost'\n                                : 'Ingredient Cost Range'}\n                            </p>\n                          </div>\n                          <div>\n                            <div className='flex items-baseline gap-1'>\n                              <span\n                                className={`text-2xl font-bold ${\n                                  minMargin < 60\n                                    ? 'text-red-500'\n                                    : minMargin > 70\n                                      ? 'text-green-500'\n                                      : ''\n                                }`}\n                              >\n                                {minMargin === maxMargin\n                                  ? `${minMargin}%`\n                                  : `${minMargin}% - ${maxMargin}%`}\n                              </span>\n                            </div>\n                            <p className='text-xs text-muted-foreground'>\n                              {minMargin === maxMargin\n                                ? 'Gross Margin'\n                                : 'Margin Range'}\n                            </p>\n                          </div>\n                        </div>\n                      </CardContent>\n                    </Card>\n\n                    <div className='flex items-center justify-between'>\n                      <div className='space-y-1'>\n                        <h3 className='text-lg font-medium'>Product Recipe</h3>\n                        <p className='text-sm text-muted-foreground'>\n                          Define ingredient consumption. Base ingredients are\n                          inherited by all variants.\n                        </p>\n                      </div>\n                      <Button\n                        type='button'\n                        variant='outline'\n                        size='sm'\n                        onClick={() =>\n                          append({\n                            ingredientId: '',\n                            quantity: 0,\n                            optionId: '',\n                          })\n                        }\n                      >\n                        <Plus className='mr-1 h-3 w-3' /> Add Ingredient\n                      </Button>\n                    </div>\n\n                    <div className='space-y-8'>\n                      {/* Base Product Section */}\n                      <div className='space-y-3'>\n                        <div className='flex items-center justify-between'>\n                          <Badge variant='secondary' className='mb-1'>\n                            Base Product\n                          </Badge>\n                        </div>\n                        {fields.filter((f: any) => !f.optionId).length ===\n                          0 && (\n                          <p className='pl-2 text-xs text-muted-foreground italic'>\n                            No base ingredients.\n                          </p>\n                        )}\n                        {fields.map((field: any, index) => {\n                          if (field.optionId && field.optionId !== '')\n                            return null\n                          return (\n                            <RecipeRow\n                              key={field.id}\n                              index={index}\n                              control={form.control}\n                              onRemove={() => remove(index)}\n                            />\n                          )\n                        })}\n                      </div>\n\n                      {/* Variants Sections - Smart Visibility */}\n                      {choices.length > 1 &&\n                        choices.map((choice: any, cIndex: number) => {\n                          const choiceId =\n                            choice.id || choice.sku || `variant-${cIndex}`\n                          const rowsWithLiveValues: any[] = fields.map(\n                            (f, i) => ({\n                              ...f,\n                              ...(recipeItems?.[i] || {}), // Merge live values from useWatch\n                              originalIndex: i,\n                            })\n                          )\n                          const baseRows = rowsWithLiveValues.filter(\n                            (f) => !f.optionId\n                          )\n\n                          const variantSpecificRows = rowsWithLiveValues.filter(\n                            (f) =>\n                              f.optionId === choiceId &&\n                              !baseRows.some(\n                                (b) => b.ingredientId === f.ingredientId\n                              )\n                          )\n\n                          return (\n                            <div key={choiceId || cIndex} className='space-y-3'>\n                              <div className='flex items-center justify-between gap-2 border-t border-dashed pt-4'>\n                                <Badge variant='secondary' className='mb-1'>\n                                  {choice.name['en'] || `Variant ${cIndex + 1}`}\n                                </Badge>\n                                {(() => {\n                                  const metric = variantMetrics.find(\n                                    (m: any) => m.id === choiceId\n                                  )\n                                  if (!metric) return null\n                                  return (\n                                    <span className='text-xs text-muted-foreground'>\n                                      <span className='font-medium text-foreground'>\n                                        ${metric.cost.toFixed(2)}\n                                      </span>{' '}\n                                      cost {' '}\n                                      <span\n                                        className={\n                                          metric.margin < 60\n                                            ? 'font-medium text-red-500'\n                                            : metric.margin > 70\n                                              ? 'font-medium text-green-500'\n                                              : 'font-medium text-foreground'\n                                        }\n                                      >\n                                        {metric.margin}%\n                                      </span>{' '}\n                                      margin\n                                    </span>\n                                  )\n                                })()}\n                                <Button\n                                  type='button'\n                                  variant='ghost'\n                                  size='sm'\n                                  className='h-7 px-2 text-xs text-primary'\n                                  onClick={() =>\n                                    append({\n                                      ingredientId: '',\n                                      quantity: 0,\n                                      optionId: choiceId,\n                                    })\n                                  }\n                                >\n                                  <Plus className='mr-1 h-3 w-3' /> Add Special\n                                  Ingredient\n                                </Button>\n                              </div>\n\n                              <div className='space-y-3'>\n                                {/* Inherited / Overrides */}\n                                {baseRows.map((baseItem) => {\n                                  const overrideIdx = fields.findIndex(\n                                    (f: any) =>\n                                      f.optionId === choiceId &&\n                                      f.ingredientId === baseItem.ingredientId\n                                  )\n\n                                  if (overrideIdx !== -1) {\n                                    return (\n                                      <RecipeRow\n                                        key={`override-${choiceId}-${(fields[overrideIdx] as any).ingredientId}-${overrideIdx}`}\n                                        index={overrideIdx}\n                                        control={form.control}\n                                        isFixedIngredient={true}\n                                        onRemove={() => remove(overrideIdx)}\n                                      />\n                                    )\n                                  }\n\n                                  return (\n                                    <VirtualInheritedRow\n                                      key={`virtual-${choiceId}-${baseItem.ingredientId}`}\n                                      ingredientId={baseItem.ingredientId}\n                                      baseQuantity={Number(\n                                        baseItem.quantity as any\n                                      )}\n                                      onOverride={(newQty: number) =>\n                                        append({\n                                          ingredientId: baseItem.ingredientId,\n                                          quantity: newQty,\n                                          optionId: choiceId,\n                                        })\n                                      }\n                                    />\n                                  )\n                                })}\n\n                                {/* Variant-Specific (non-base) */}\n                                {variantSpecificRows.map((vRow: any) => (\n                                  <RecipeRow\n                                    key={`special-${choiceId}-${vRow.id}`}\n                                    index={vRow.originalIndex}\n                                    control={form.control}\n                                    isFixedIngredient={false}\n                                    onRemove={() => remove(vRow.originalIndex)}\n                                  />\n                                ))}\n                              </div>\n                            </div>\n                          )\n                        })}\n                    </div>\n                  </>\n                )}\n              </TabsContent>\n            </Tabs>\n\n            <div className='mt-auto flex justify-end pt-4'>\n              <Button type='submit' disabled={isPending}>\n                {isPending ? 'Saving...' : 'Save Product'}\n              </Button>\n            </div>\n          </form>\n        </Form>\n      </SheetContent>\n    </Sheet>\n  )\n}\n","usedDeprecatedRules":[]}]
